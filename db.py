import os
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import sessionmaker, DeclarativeBase, Mapped, mapped_column
from sqlalchemy import Integer, String, select, Column, BigInteger, update 
from datetime import datetime, timedelta
import asyncio
from sqlalchemy import JSON
import json


DATABASE_URL = "sqlite+aiosqlite:///channels.db"
async_engine = create_async_engine(DATABASE_URL, echo=False)

AsyncSessionLocal = sessionmaker(
    bind=async_engine,
    class_=AsyncSession,
    expire_on_commit=False
)

class Base(DeclarativeBase):
    pass
    

class Channel(Base):
    __tablename__ = 'channels'

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)

    channel_id: Mapped[int] = mapped_column(Integer, nullable=False)
    channel_name: Mapped[str] = mapped_column(String, nullable=True)
    

class Filter(Base):
    __tablename__ = 'filters'

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    filter_text: Mapped[str] = mapped_column(String, nullable=False)


class Slova(Base):
    __tablename__ = 'slova'

    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    filter_text: Mapped[str] = mapped_column(String, nullable=False)



class OtkonechenieResume(Base):
    __tablename__ = 'otkonechenie_resume'
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    message_id: Mapped[int] = mapped_column(Integer, nullable=False)
    message_text = Column(String, nullable=False)
    json_text = Column(String, nullable=False)
    message_time = Column(String, nullable=False)
    
class FinalResume(Base):
    __tablename__ = 'final_resume'
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    message_id: Mapped[int] = mapped_column(Integer, nullable=False)
    message_text = Column(String, nullable=False)
    json_text = Column(String, nullable=False)
    message_time = Column(String, nullable=False)


class UtochnenieResume(Base):
    __tablename__ = 'utochnenie_resume'
    
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
    message_id: Mapped[int] = mapped_column(Integer, nullable=False)
    message_text = Column(String, nullable=False)
    json_text = Column(String, nullable=False)
    message_time = Column(String, nullable=False)
 
    
class MessageMapping(Base):
    __tablename__ = "message_mapping"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    src_chat_id = Column(BigInteger, index=True)
    src_msg_id = Column(BigInteger, index=True)
    dst_chat_id = Column(BigInteger, index=True)
    dst_msg_id = Column(BigInteger, index=True)
    deadline_date = Column(String, nullable=True)  
    deadline_time = Column(String, nullable=True) 


class LastSequenceNumber(Base):
    __tablename__ = "last_sequence_number"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    last_number = Column(Integer, nullable=False)


class PrivyazanieEmail(Base):
    __tablename__ = "privyazanie_email"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    user_name_tg = Column(String, nullable=False)
    user_email = Column(String, nullable=True)
    email_password = Column(String, nullable=True)
    
class PrivyazanieTelegram(Base):
    __tablename__ = "privyazanie_telegram"
    
    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    user_name_tg = Column(String, nullable=False)
    api_id = Column(String, nullable=False)
    api_hash = Column(String, nullable=False)
    


class SaveResumes(Base):
    __tablename__ = "save_resumes"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    canditdate_name = Column(String, nullable=False)
    resume_text = Column(String, nullable=False)
    

async def init_db():
    print("üß± –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    print("üìã –¢–∞–±–ª–∏—Ü—ã –≤ metadata:", list(Base.metadata.tables.keys()))
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    print("‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã (–µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ).")


async def add_channel(channel_name: str, channel_id: int):
    async with AsyncSessionLocal() as session:
        query = select(Channel).where(Channel.channel_id == channel_id)
        result = await session.execute(query)
        if result.scalars().first():
            return '–¢–∞–∫–æ–π –∫–∞–Ω–∞–ª —É–∂–µ –µ—Å—Ç—å'
        else:
            try:
                channel = Channel(channel_name=channel_name, channel_id=channel_id)
                session.add(channel)
                await session.commit()
                await session.refresh(channel)
                
            except:
                return "–ö–∞–Ω–∞–ª –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å"
        

async def remove_channel(channel_id: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Channel).where(Channel.channel_id == channel_id)
        )
        channel = result.scalar_one_or_none()
        if channel:
            await session.delete(channel)
            await session.commit()
            print(f"–ö–∞–Ω–∞–ª {channel_id} —É–¥–∞–ª—ë–Ω –∏–∑ –±–∞–∑—ã.")
        else:
            print(f"–ö–∞–Ω–∞–ª {channel_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")


async def get_all_channels():
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(Channel))
        channels = result.scalars().all()
        return channels
    

async def add_filter(filter_text):
    async with AsyncSessionLocal() as session:
        query = select(Filter).where(Filter.filter_text == filter_text)
        result = await session.execute(query)
        if result.scalars().first():
            return True
        else:
            filter = Filter(filter_text=filter_text)
            session.add(filter)
            await session.commit()
            await session.refresh(filter)

async def get_all_filters():
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(Filter))
        filters = result.scalars().all()
        return filters
    
async def remove_filter(id):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Filter).where(Filter.id == id)
        )
        filter = result.scalar_one_or_none()
        if filter:
            await session.delete(filter)
            await session.commit()






async def add_slovo(filter_text):
    async with AsyncSessionLocal() as session:
        query = select(Filter).where(Filter.filter_text == filter_text)
        result = await session.execute(query)
        if result.scalars().first():
            return True
        else:
            filter = Slova(filter_text=filter_text)
            session.add(filter)
            await session.commit()
            await session.refresh(filter)


async def get_all_slova():
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(Slova))
        filters = result.scalars().all()
        return filters


async def remove_slovo(id):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Slova).where(Slova.id == id)
        )
        filter = result.scalar_one_or_none()
        if filter:
            await session.delete(filter)
            await session.commit()








async def add_message_mapping(
    session: AsyncSession,
    src_chat_id: int,
    src_msg_id: int,
    dst_chat_id: int,
    dst_msg_id: int,
    deadline_date: str | None = None,
    deadline_time: str | None = None
):
    mapping = MessageMapping(
        src_chat_id=src_chat_id,
        src_msg_id=src_msg_id,
        dst_chat_id=dst_chat_id,
        dst_msg_id=dst_msg_id,
        deadline_date=deadline_date,
        deadline_time=deadline_time
    )
    session.add(mapping)
    await session.commit()


async def get_all_message_mappings(session: AsyncSession):
    result = await session.execute(select(MessageMapping))
    return result.scalars().all()

async def remove_message_mapping(session: AsyncSession, src_chat_id: int, src_msg_id: int):
    result = await session.execute(
        select(MessageMapping).where(
            (MessageMapping.src_chat_id == src_chat_id) & (MessageMapping.src_msg_id == src_msg_id)
        )
    )
    mapping = result.scalars().first()
    if mapping:
        await session.delete(mapping)
        await session.commit()


async def get_next_sequence_number() -> int:
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å —Å id=1 –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º, –µ—Å–ª–∏ –Ω–µ—Ç
    async with AsyncSessionLocal() as session:
        record = await session.get(LastSequenceNumber, 1)
        if not record:
            record = LastSequenceNumber(id=1, last_number=0)
            session.add(record)
            await session.commit()

        record.last_number += 1
        await session.commit()
        return record.last_number
    
    
    
    
async def add_otkonechenie_resume(message_id: int, message_text: str, json_text: dict):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å OtkonechenieResume.
    –ï—Å–ª–∏ message_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ JSON.
    """
    if isinstance(json_text, dict):
        json_text = json.dumps(json_text)

    async with AsyncSessionLocal() as session:
        try:
            result = await session.execute(
                select(OtkonechenieResume).where(OtkonechenieResume.message_id == message_id)
            )
            existing_record = result.scalar_one_or_none()

            if existing_record:
                existing_record.message_text = message_text
                existing_record.json_text = json_text
                existing_record.message_time = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                print(f"‚ôªÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å OtkonechenieResume —Å message_id={message_id}")
            else:
                new_record = OtkonechenieResume(
                    message_id=message_id,
                    message_text=message_text,
                    json_text=json_text,
                    message_time=datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                )
                session.add(new_record)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å OtkonechenieResume —Å message_id={message_id}")

            await session.commit()

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ OtkonechenieResume: {e}")


async def remove_old_otkonechenie_resumes(hours: int = 12):
    """
    –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã otkonechenie_resume,
    —É –∫–æ—Ç–æ—Ä—ã—Ö message_time —Å—Ç–∞—Ä—à–µ N —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12).
    """
    async with AsyncSessionLocal() as session:  # type: AsyncSession
        try:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≥–æ–≤—É—é –¥–∞—Ç—É
            threshold_time = datetime.now() - timedelta(hours=hours)

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
            result = await session.execute(select(OtkonechenieResume))
            records = result.scalars().all()

            deleted_count = 0

            for record in records:
                # message_time —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–µ "–î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú:–°–°"
                try:
                    record_time = datetime.strptime(record.message_time, "%d.%m.%Y %H:%M:%S")
                    if record_time < threshold_time:
                        await session.delete(record)
                        deleted_count += 1
                except ValueError:
                    # –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –±–∏—Ç—ã–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                    continue

            await session.commit()

            print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {deleted_count} –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ {hours} —á–∞—Å–æ–≤.")

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π: {e}")

    
async def periodic_cleanup_task():
    while True:
        try:
            await remove_old_otkonechenie_resumes(hours=12)
            await remove_old_utochnenie_resumes(hours=12)
            await remove_old_final_resumes(hours=12)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–µ: {e}")
        await asyncio.sleep(60 * 60) 
        
        
async def get_otkolenie_resume(message_id: int):
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(OtkonechenieResume).where(OtkonechenieResume.message_id == message_id))
        return result.scalar_one_or_none()
    
# ===============================================================
#  FINAL RESUME (–§–ò–ù–ê–õ–ò–°–¢–´)
# ===============================================================

async def add_final_resume(message_id: int, message_text: str, json_text: dict):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å FinalResume.
    –ï—Å–ª–∏ message_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ JSON.
    """
    if isinstance(json_text, dict):
        json_text = json.dumps(json_text)
        
        
    async with AsyncSessionLocal() as session:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º message_id
            result = await session.execute(
                select(FinalResume).where(FinalResume.message_id == message_id)
            )
            existing_record = result.scalar_one_or_none()

            if existing_record:
                # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
                existing_record.message_text = message_text
                existing_record.json_text = json_text
                existing_record.message_time = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                print(f"‚ôªÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å FinalResume —Å message_id={message_id}")
            else:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                new_record = FinalResume(
                    message_id=message_id,
                    message_text=message_text,
                    json_text=json_text,
                    message_time=datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                )
                session.add(new_record)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å FinalResume —Å message_id={message_id}")

            await session.commit()

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ FinalResume: {e}")



async def remove_old_final_resumes(hours: int = 12):
    """–£–¥–∞–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—é–º–µ —Å—Ç–∞—Ä—à–µ N —á–∞—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 12)."""
    async with AsyncSessionLocal() as session:
        try:
            threshold_time = datetime.now() - timedelta(hours=hours)
            result = await session.execute(select(FinalResume))
            records = result.scalars().all()
            deleted_count = 0

            for record in records:
                try:
                    record_time = datetime.strptime(record.message_time, "%d.%m.%Y %H:%M:%S")
                    if record_time < threshold_time:
                        await session.delete(record)
                        deleted_count += 1
                except ValueError:
                    continue

            await session.commit()
            print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {deleted_count} —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—é–º–µ —Å—Ç–∞—Ä—à–µ {hours} —á–∞—Å–æ–≤.")

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—é–º–µ: {e}")


async def get_final_resume(message_id: int):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(FinalResume).where(FinalResume.message_id == message_id)
        )
        return result.scalar_one_or_none()



# ===============================================================
#  UTOCHNENIE RESUME (–¢–†–ï–ë–£–Æ–¢ –£–¢–û–ß–ù–ï–ù–ò–ô)
# ===============================================================

async def add_utochnenie_resume(message_id: int, message_text: str, json_text: dict):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å UtochnenieResume.
    –ï—Å–ª–∏ message_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ JSON.
    """
    if isinstance(json_text, dict):
        json_text = json.dumps(json_text)

    async with AsyncSessionLocal() as session:
        try:
            result = await session.execute(
                select(UtochnenieResume).where(UtochnenieResume.message_id == message_id)
            )
            existing_record = result.scalar_one_or_none()

            if existing_record:
                existing_record.message_text = message_text
                existing_record.json_text = json_text
                existing_record.message_time = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                print(f"‚ôªÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å UtochnenieResume —Å message_id={message_id}")
            else:
                new_record = UtochnenieResume(
                    message_id=message_id,
                    message_text=message_text,
                    json_text=json_text,
                    message_time=datetime.now().strftime("%d.%m.%Y %H:%M:%S")
                )
                session.add(new_record)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å UtochnenieResume —Å message_id={message_id}")

            await session.commit()

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UtochnenieResume: {e}")


async def remove_old_utochnenie_resumes(hours: int = 12):
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã utochnenie_resume, —Å—Ç–∞—Ä—à–µ N —á–∞—Å–æ–≤."""
    async with AsyncSessionLocal() as session:
        try:
            threshold_time = datetime.now() - timedelta(hours=hours)
            result = await session.execute(select(UtochnenieResume))
            records = result.scalars().all()
            deleted_count = 0

            for record in records:
                try:
                    record_time = datetime.strptime(record.message_time, "%d.%m.%Y %H:%M:%S")
                    if record_time < threshold_time:
                        await session.delete(record)
                        deleted_count += 1
                except ValueError:
                    continue

            await session.commit()
            print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {deleted_count} —É—Ç–æ—á–Ω—è—é—â–∏—Ö —Ä–µ–∑—é–º–µ —Å—Ç–∞—Ä—à–µ {hours} —á–∞—Å–æ–≤.")

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—Ç–æ—á–Ω—è—é—â–∏—Ö —Ä–µ–∑—é–º–µ: {e}")


async def get_utochnenie_resume(message_id: int):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(UtochnenieResume).where(UtochnenieResume.message_id == message_id)
        )
        return result.scalar_one_or_none()    




# ===============================================================
#  SAVE RESUMES (–°–û–•–†–ê–ù–Ø–Æ–¢–°–Ø)
# ===============================================================


async def add_save_resume(canditdate_name: str, resume_text: str):
    async with AsyncSessionLocal() as session:
        try:
            resume = SaveResumes(
                canditdate_name=canditdate_name,
                resume_text=resume_text,
            )
            session.add(resume)
            await session.commit()
            await session.refresh(resume)
            
        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ SaveResumes: {e}")


async def get_save_resume(canditdate_name: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(SaveResumes).where(SaveResumes.canditdate_name == canditdate_name)
        )
        return result.scalar_one_or_none()


async def remove_save_resume(canditdate_name: str):
    async with AsyncSessionLocal() as session:
        try:
            result = await session.execute(
                select(SaveResumes).where(SaveResumes.canditdate_name == canditdate_name)
            )
            record = result.scalar_one_or_none()
            if record:
                await session.delete(record)
                await session.commit()
                print(f"üßπ –£–¥–∞–ª–µ–Ω–æ —Ä–µ–∑—é–º–µ {canditdate_name} –∏–∑ —Ç–∞–±–ª–∏—Ü—ã save_resumes.")
            else:
                print(f"‚ùå –†–µ–∑—é–º–µ {canditdate_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ save_resumes.")
        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ SaveResumes: {e}")

#=====================================  
#–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞–º
#=====================================

async def get_user_with_privyazka(user_name_tg: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(PrivyazanieEmail).where(PrivyazanieEmail.user_name_tg == user_name_tg)
        )
        res = result.scalar_one_or_none()
        if res:
            return res
        result = await session.execute(
            select(PrivyazanieTelegram).where(PrivyazanieTelegram.user_name_tg == user_name_tg)
        )
        res = result.scalar_one_or_none()
        return res


async def add_email(user_name_tg: str, user_email: str, password: str):
    async with AsyncSessionLocal() as session:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å
            res = await session.execute(
                select(PrivyazanieEmail).where(
                    PrivyazanieEmail.user_name_tg == user_name_tg
                )
            )
            record = res.scalar_one_or_none()

            if record:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
                await session.execute(
                    update(PrivyazanieEmail)
                    .where(PrivyazanieEmail.user_name_tg == user_name_tg)
                    .values(user_email=user_email, email_password=password)
                )
                print(f"‚ôªÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å PrivyazanieEmail –¥–ª—è {user_name_tg}")
            else:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                new_email = PrivyazanieEmail(
                    user_name_tg=user_name_tg,
                    user_email=user_email,
                    email_password=password,
                )
                session.add(new_email)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å PrivyazanieEmail –¥–ª—è {user_name_tg}")

            await session.commit()

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Email: {e}")


async def add_session_tg(user_name_tg: str, api_id: str, api_hash: str):
    async with AsyncSessionLocal() as session:
        try:
            # 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å
            res = await session.execute(
                select(PrivyazanieTelegram).where(PrivyazanieTelegram.user_name_tg == user_name_tg)
            )
            record = res.scalar_one_or_none()

            if record:
                # 2Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
                await session.execute(
                    update(PrivyazanieTelegram)
                    .where(PrivyazanieTelegram.user_name_tg == user_name_tg)
                    .values(api_id=api_id, api_hash=api_hash)
                )
                print(f"‚ôªÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å PrivyazanieTelegram –¥–ª—è {user_name_tg}")

            else:
                # 3Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                new_record = PrivyazanieTelegram(
                    user_name_tg=user_name_tg,
                    api_id=api_id,
                    api_hash=api_hash,
                )
                session.add(new_record)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å PrivyazanieTelegram –¥–ª—è {user_name_tg}")

            # 4Ô∏è‚É£ –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            await session.commit()

        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Telegram: {e}")

async def get_tg_user(user_name_tg: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(PrivyazanieTelegram).where(PrivyazanieTelegram.user_name_tg == user_name_tg)
        )
        return result.scalar_one_or_none()

async def get_email_user(user_name_tg: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(PrivyazanieEmail).where(PrivyazanieEmail.user_name_tg == user_name_tg)
        )
        return result.scalar_one_or_none()



async def remove_session_tg(user_name_tg: str):
    async with AsyncSessionLocal() as session:
        try:
            result = await session.execute(
                select(PrivyazanieTelegram).where(PrivyazanieTelegram.user_name_tg == user_name_tg)
            )
            record = result.scalar_one_or_none()
            if record:
                await session.delete(record)
                await session.commit()
                print(f"üßπ –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å PrivyazanieTelegram –¥–ª—è {user_name_tg}")
            else:
                print(f"‚ùå –ó–∞–ø–∏—Å—å PrivyazanieTelegram –¥–ª—è {user_name_tg} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Telegram: {e}")

async def remove_session_email(user_name_tg: str):
    async with AsyncSessionLocal() as session:
        try:
            result = await session.execute(
                select(PrivyazanieEmail).where(PrivyazanieEmail.user_name_tg == user_name_tg)
            )
            record = result.scalar_one_or_none()
            if record:
                await session.delete(record)
                await session.commit()
                print(f"üßπ –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å PrivyazanieEmail –¥–ª—è {user_name_tg}")
            else:
                print(f"‚ùå –ó–∞–ø–∏—Å—å PrivyazanieEmail –¥–ª—è {user_name_tg} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        except Exception as e:
            await session.rollback()
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Email: {e}")